#!/bin/bash
#
# This is the main `abw` program.
#
# It is a wrapper for the other tools.
#
# Usage:
#
#    abw -list
#    abw -list COLLECTION
#    abw -list --meta "hash,name" COLLECTION
#
#    abw --show ID
#    abw --show --collection COLLECTION ID
#    abw --show --collection COLLECTION --meta ID
#    abw --show --collection COLLECTION --data ID
#
#    abw --grep REGEX
#    abw --grep --collection COLLECTION REGEX
#    abw --grep --collection COLLECTION -m REGEX
#    abw --grep --collection COLLECTION -d REGEX
#
#    abw --process FILE [...]
#    abw --process FILE [...] > OUTPUT
#    abw --process -output OUTPUT FILE [...]
#
#    abw --import FILE [...]
#    abw --import -recursive DIRECTORY [...]
#    abw --import -recursive --collection COLLECTION DIRECTORY [...]
#

BASEDIR=`dirname $0`

args=${@}
args=${args//--process/-p}
args=${args//--import/-i}
args=${args//--help/-h} # TODO

args=${@}
# list
args=${args//--list/-l}
# show
args=${args//--show/-s}
# grep
args=${args//--grep/-g}
# process
args=${args//--process/-p}
args=${args//--output/-o}
# import
args=${args//--import/-i}
args=${args//--recursive/-r}
# generic
args=${args//--collection/-c}
args=${args//--verbose/-v}
args=${args//--force/-f}
args=${args//--meta/-m}
args=${args//--data/-d}
args=${args//--help/-h} # TODO

shopt -s extglob # remove unknown
args=${args//--+([a-zA-Z0-9-])/-?}

declare -A options;
OPTSTRING="lspoic:rvgmdh"

while getopts "$OPTSTRING" name ${args}; do

      if [[ ${OPTARG} ]]; then
        options[${name}]=${OPTARG};
      else
        options[${name}]=${name};
      fi;
done;
shift $(( ${OPTIND} - 1 ));

if [[ ${options["l"]} ]]; then
    $BASEDIR/abw-list.sh ${args}
elif [[ ${options["s"]} ]]; then
    $BASEDIR/abw-show.sh ${args}
elif [[ ${options["g"]} ]]; then
    $BASEDIR/abw-grep.sh ${args}
elif [[ ${options["p"]} ]]; then
    $BASEDIR/abw-process.sh ${args}
elif [[ "${options["i"]}" ]]; then
    $BASEDIR/abw-import.sh ${args}
else
    echo "abw: missing or invalid arguments";
    exit 1;
fi;

