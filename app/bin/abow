#!/bin/bash
#
# This is the main `abow` program.
#
# It is a wrapper for the other tools.
#
# Usage:
#
#    abow -list
#    abow -list COLLECTION
#    abow -list --meta "hash,name" COLLECTION
#
#    abow --show ID
#    abow --show --collection COLLECTION ID
#    abow --show --collection COLLECTION --meta ID
#    abow --show --collection COLLECTION --data ID
#
#    abow --grep REGEX
#    abow --grep --collection COLLECTION REGEX
#    abow --grep --collection COLLECTION -m REGEX
#    abow --grep --collection COLLECTION -d REGEX
#
#    abow --process FILE [...]
#    abow --process FILE [...] > OUTPUT
#    abow --process -output OUTPUT FILE [...]
#
#    abow --import FILE [...]
#    abow --import -recursive DIRECTORY [...]
#    abow --import -recursive --collection COLLECTION DIRECTORY [...]
#

BASEDIR=`dirname $0`

args=${@}
args=${args//--process/-p}
args=${args//--import/-i}
args=${args//--help/-h} # TODO

args=${@}
# list
args=${args//--list/-l}
# show
args=${args//--show/-s}
# grep
args=${args//--grep/-g}
# process
args=${args//--process/-p}
args=${args//--output/-o}
# import
args=${args//--import/-i}
args=${args//--recursive/-r}
# generic
args=${args//--collection/-c}
args=${args//--verbose/-v}
args=${args//--force/-f}
args=${args//--meta/-m}
args=${args//--data/-d}
args=${args//--help/-h} # TODO

shopt -s extglob # remove unknown
args=${args//--+([a-zA-Z0-9-])/-?}

declare -A options;
OPTSTRING="lspoic:rvgmdh"

while getopts "$OPTSTRING" name ${args}; do

      if [[ ${OPTARG} ]]; then
        options[${name}]=${OPTARG};
      else
        options[${name}]=${name};
      fi;
done;
shift $(( ${OPTIND} - 1 ));

if [[ ${options["l"]} ]]; then
    $BASEDIR/abow-list.sh ${args}
elif [[ ${options["s"]} ]]; then
    $BASEDIR/abow-show.sh ${args}
elif [[ ${options["g"]} ]]; then
    $BASEDIR/abow-grep.sh ${args}
elif [[ ${options["p"]} ]]; then
    $BASEDIR/abow-process.sh ${args}
elif [[ "${options["i"]}" ]]; then
    $BASEDIR/abow-import.sh ${args}
else
    echo "abow: missing or invalid arguments";
    exit 1;
fi;

